<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cycling Training Dashboard - __ATHLETE_NAME__</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg-primary: #0f1117;
  --bg-card: #1a1d27;
  --bg-card-alt: #1e2130;
  --border: #2a2d3a;
  --text-primary: #e8eaf0;
  --text-secondary: #9ca3b4;
  --text-muted: #6b7280;
  --blue: #3b82f6;
  --blue-light: #60a5fa;
  --blue-dim: #1e3a5f;
  --red: #ef4444;
  --red-light: #f87171;
  --red-dim: #5f1e1e;
  --green: #22c55e;
  --green-light: #4ade80;
  --green-dim: #1e5f2e;
  --yellow: #eab308;
  --yellow-dim: #5f4e1e;
  --orange: #d97706;
  --purple: #a855f7;
  --cyan: #7dd3fc;
  --accent: #3b82f6;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}
/* Section Nav */
.section-nav {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(15,17,23,0.95);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  white-space: nowrap;
  scrollbar-width: none;
}
.section-nav::-webkit-scrollbar { display: none; }
.section-nav-inner {
  display: flex;
  gap: 0;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}
.section-nav a {
  display: inline-block;
  padding: 12px 18px;
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 13px;
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s;
}
.section-nav a:hover {
  color: var(--text-primary);
  border-bottom-color: var(--blue);
}
/* Collapsible sections */
.collapsible-header {
  cursor: pointer;
  user-select: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.collapsible-header .toggle-icon {
  font-size: 24px;
  color: var(--text-secondary);
  transition: transform 0.2s;
  padding: 4px 8px;
}
.collapsible-header.open .toggle-icon { transform: rotate(90deg); }
.collapsible-content { display: none; }
.collapsible-content.open { display: block; }
/* Today's Focus */
.today-focus {
  padding: 16px 20px;
  background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.06));
  border: 1px solid rgba(59,130,246,0.2);
  border-radius: 10px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.today-focus .focus-icon { font-size: 24px; }
.today-focus .focus-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
.today-focus .focus-detail { font-size: 13px; color: var(--text-secondary); }
/* TSS toggle */
.tss-toggle {
  display: inline-block;
  padding: 4px 12px;
  background: rgba(59,130,246,0.12);
  border: 1px solid rgba(59,130,246,0.25);
  border-radius: 6px;
  color: var(--blue-light);
  font-size: 12px;
  cursor: pointer;
  margin-left: 12px;
}
.tss-toggle:hover { background: rgba(59,130,246,0.2); }
/* Data freshness */
.data-freshness {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(34,197,94,0.08);
  border: 1px solid rgba(34,197,94,0.15);
  border-radius: 12px;
  font-size: 11px;
  color: var(--green-light);
  margin-top: 6px;
}
.data-freshness .pulse {
  width: 6px; height: 6px;
  background: var(--green);
  border-radius: 50%;
}
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }
.header {
  background: linear-gradient(135deg, #1a1d27 0%, #0f1117 100%);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px 32px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}
.header-left h1 {
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--blue-light), var(--cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}
.header-left .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 2px; }
.header-stats {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}
.stat-box {
  text-align: center;
  padding: 8px 16px;
  background: rgba(59,130,246,0.08);
  border: 1px solid rgba(59,130,246,0.15);
  border-radius: 10px;
  min-width: 90px;
}
.stat-box.red { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.15); }
.stat-box.green { background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.15); }
.stat-box.orange { background: rgba(217,119,6,0.08); border-color: rgba(249,115,22,0.15); }
.stat-box .value { font-size: 24px; font-weight: 700; }
.stat-box .label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-box.blue .value { color: var(--blue-light); }
.stat-box.red .value { color: var(--red-light); }
.stat-box.green .value { color: var(--green-light); }
.stat-box.orange .value { color: var(--orange); }
.countdown-box {
  text-align: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(6,182,212,0.12));
  border: 1px solid rgba(59,130,246,0.25);
  border-radius: 12px;
}
.countdown-box .days { font-size: 36px; font-weight: 800; color: var(--cyan); }
.countdown-box .label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.grid-full { grid-column: 1 / -1; }
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  overflow: hidden;
}
.card h2 {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}
.card h2 .icon { font-size: 18px; }
.card h3 {
  font-size: 14px;
  font-weight: 600;
  margin: 16px 0 8px;
  color: var(--text-secondary);
}
.chart-container { position: relative; height: 280px; }
.chart-container.tall { height: 320px; }
.mini-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.mini-stat {
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  text-align: center;
}
.mini-stat .val { font-size: 20px; font-weight: 700; }
.mini-stat .lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
.insight-card {
  padding: 14px 16px;
  background: rgba(59,130,246,0.06);
  border-left: 3px solid var(--blue);
  border-radius: 0 8px 8px 0;
  margin-bottom: 10px;
  font-size: 13px;
  line-height: 1.5;
}
.insight-card .type { font-weight: 600; color: var(--blue-light); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.segment-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.segment-table th {
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 11px;
  text-transform: uppercase;
}
.segment-table td {
  padding: 8px 10px;
  border-bottom: 1px solid rgba(42,45,58,0.5);
  color: var(--text-primary);
}
.segment-table tr:hover td { background: rgba(255,255,255,0.02); }
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}
.badge-green { background: var(--green-dim); color: var(--green-light); }
.badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
.badge-red { background: var(--red-dim); color: var(--red-light); }
.badge-blue { background: var(--blue-dim); color: var(--blue-light); }
.coach-text {
  font-size: 14px;
  line-height: 1.75;
  color: var(--text-secondary);
}
.coach-text p { margin-bottom: 16px; }
.coach-text strong { color: var(--text-primary); }
.finding-box {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: rgba(34,197,94,0.06);
  border: 1px solid rgba(34,197,94,0.15);
  border-radius: 8px;
  margin: 12px 0;
  font-size: 13px;
}
.finding-box .emoji { font-size: 20px; }
.recovery-bracket {
  display: flex;
  gap: 12px;
  margin: 12px 0;
}
.bracket {
  flex: 1;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
}
.bracket.red-b { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); }
.bracket.yellow-b { background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.2); }
.bracket.green-b { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); }
.bracket .bracket-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }
.bracket .bracket-value { font-size: 22px; font-weight: 700; margin: 4px 0; }
.bracket .bracket-n { font-size: 11px; color: var(--text-muted); }
.phase-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
.phase-base { background: rgba(59,130,246,0.15); color: var(--blue-light); }
.stop-timeline {
  position: relative;
  padding-left: 24px;
  border-left: 2px solid var(--border);
}
.stop-item {
  position: relative;
  padding: 10px 0 10px 16px;
}
.stop-item::before {
  content: '';
  position: absolute;
  left: -29px;
  top: 16px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--blue);
  border: 2px solid var(--bg-card);
}
.stop-item.hot::before { background: var(--orange); }
.stop-item .stop-name { font-weight: 600; font-size: 14px; }
.stop-item .stop-detail { font-size: 12px; color: var(--text-secondary); }
.weekly-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}
.ftp-timeline {
  display: flex;
  align-items: center;
  gap: 0;
  margin: 16px 0;
  position: relative;
}
.ftp-marker {
  text-align: center;
  flex: 1;
  position: relative;
  padding-top: 24px;
}
.ftp-marker::before {
  content: '';
  position: absolute;
  top: 8px;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--blue), var(--cyan));
}
.ftp-marker .dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--blue-light);
  margin: 0 auto 6px;
  position: relative;
  z-index: 1;
}
.ftp-marker .ftp-val { font-size: 18px; font-weight: 700; color: var(--blue-light); }
.ftp-marker .ftp-date { font-size: 11px; color: var(--text-muted); }
@media (max-width: 900px) {
  .grid, .grid-3 { grid-template-columns: 1fr; }
  .header { flex-direction: column; align-items: flex-start; }
  .header-stats { width: 100%; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
}
/* Mobile sticky mini-header */
.mobile-sticky-header {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 200;
  background: rgba(15,17,23,0.97);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  justify-content: space-around;
  font-size: 12px;
  font-weight: 600;
}
.mobile-sticky-header .ms-item { text-align: center; }
.mobile-sticky-header .ms-val { color: var(--blue-light); font-size: 16px; }
.mobile-sticky-header .ms-lbl { color: var(--text-muted); font-size: 10px; text-transform: uppercase; }
/* Table scroll wrapper */
.table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
@media (max-width: 600px) {
  .mobile-sticky-header { display: flex; }
  body { padding-top: 52px; }
  .container { padding: 12px; }
  .header { padding: 16px; border-radius: 10px; }
  .header-left h1 { font-size: 22px; }
  .header-stats { grid-template-columns: repeat(2, 1fr); gap: 6px; }
  .stat-box { padding: 6px 8px; min-width: unset; }
  .stat-box .value { font-size: 18px; }
  .countdown-box { padding: 8px 12px; }
  .countdown-box .days { font-size: 24px; }
  .card { padding: 16px; border-radius: 10px; }
  .card h2 { font-size: 14px; }
  .mini-stats { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .segment-table { font-size: 12px; }
  .segment-table th, .segment-table td { padding: 6px; }
  .section-nav a { padding: 10px 12px; font-size: 12px; }
  .recovery-bracket { flex-direction: column; }
  .chart-container { height: 200px !important; }
  .chart-container.tall { height: 240px !important; }
  .grid-3 > div .chart-container { height: 180px !important; }
  .ftp-timeline { flex-wrap: wrap; }
  .ftp-marker .ftp-val { font-size: 14px; }
  .coach-text { font-size: 13px; }
  .stop-timeline { padding-left: 16px; }
}
</style>
</head>
<body>
<div class="mobile-sticky-header">
  <div class="ms-item"><div class="ms-val">__MOBILE_FTP__W</div><div class="ms-lbl">FTP</div></div>
  <div class="ms-item"><div class="ms-val">__MOBILE_CTL__</div><div class="ms-lbl">CTL</div></div>
  <div class="ms-item"><div class="ms-val">__HALV_DAYS__d</div><div class="ms-lbl">Halvvattern</div></div>
  <div class="ms-item"><div class="ms-val">__VATT_DAYS__d</div><div class="ms-lbl">Vatternrundan</div></div>
</div>
<div class="container">

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <h1>__ATHLETE_NAME__</h1>
    <div class="subtitle">Training Dashboard &middot; __HEADER_DATE__ &middot; Coach: __COACH_NAME__</div>
  </div>
  <div class="header-stats">
    <div class="countdown-box">
      <div class="days">__HALV_DAYS__</div>
      <div class="label">Days to Halvvattern</div>
    </div>
    <div class="countdown-box">
      <div class="days">__VATT_DAYS__</div>
      <div class="label">Days to Vatternrundan</div>
    </div>
    <div class="stat-box blue">
      <div class="value">__FTP__W</div>
      <div class="label">FTP</div>
    </div>
    <div class="stat-box blue">
      <div class="value">__CTL__</div>
      <div class="label">CTL (Fitness)</div>
    </div>
    <div class="stat-box red">
      <div class="value">__ATL__</div>
      <div class="label">ATL (Fatigue)</div>
    </div>
    <div class="stat-box green">
      <div class="value">__TSB__</div>
      <div class="label">TSB (Form)</div>
    </div>
  </div>
</div>

<!-- SECTION NAV -->
<div class="section-nav">
  <div class="section-nav-inner">
    <a href="#overview">Overview</a>
    <a href="#this-week">This Week</a>
    <a href="#recovery">Recovery</a>
    <a href="#training">Training</a>
    <a href="#race-plans">Race Plans</a>
    <a href="#coach">Coach</a>
  </div>
</div>

<!-- THIS WEEK (moved to position #2) -->
<div id="this-week" style="margin-bottom:20px">
  <div class="card">
    <h2><span class="icon">üìã</span> This Week (__WEEK_RANGE__)</h2>
    <div class="today-focus">
      <span class="focus-icon">__TODAY_FOCUS_ICON__</span>
      <div>
        <div class="focus-text">__TODAY_FOCUS_TITLE__</div>
        <div class="focus-detail">__TODAY_FOCUS_DETAIL__</div>
      </div>
    </div>
    <div class="mini-stats">
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__WEEK_TSS_ACTUAL__</div><div class="lbl">TSS Actual</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--text-secondary)">__WEEK_TSS_PLANNED__</div><div class="lbl">TSS Planned</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--green-light)">__WEEK_PROGRESS__</div><div class="lbl">Progress</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__WEEK_HOURS__</div><div class="lbl">Hours Done</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__WEEK_COMPLETED__</div><div class="lbl">Completed</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__WEEK_AVG_IF__</div><div class="lbl">Avg IF</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--orange)">__WEEK_PEAK_IF__</div><div class="lbl">Peak IF</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--yellow)">__WEEK_AVG_RECOVERY__</div><div class="lbl">Avg Recovery</div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px">
      <div>
        <h3>Workouts</h3>
        <div class="table-scroll"><table class="segment-table">
          <thead><tr><th>Day</th><th>Workout</th><th>TSS</th><th>NP</th><th>Quality</th></tr></thead>
          <tbody>
__WEEK_WORKOUT_ROWS__
          </tbody>
        </table></div>
      </div>
      <div>
        <h3>PMC Trend</h3>
        <div style="font-size:14px;color:var(--text-secondary);line-height:2">
          __WEEK_PMC_TEXT__
        </div>
        <h3 style="margin-top:16px">Recovery This Week</h3>
        <div style="font-size:14px;color:var(--text-secondary);line-height:2">
          __WEEK_RECOVERY_TEXT__
        </div>
      </div>
    </div>
  </div>


</div>

<!-- ROW 1: Training Load + PMC -->
<div id="overview" class="grid">
  <div class="card">
    <h2><span class="icon">üìä</span> Weekly Training Load <span id="tssRangeLabel">(Last 20 Weeks)</span> <span class="tss-toggle" id="tssToggle" onclick="toggleTSSRange()">Show full year</span></h2>
    <div class="chart-container tall">
      <canvas id="tssChart"></canvas>
    </div>
  </div>
  <div class="card">
    <h2><span class="icon">üìà</span> Performance Management Chart</h2>
    <div class="chart-container tall">
      <canvas id="pmcChart"></canvas>
    </div>
  </div>
</div>

<!-- Power Zone Distribution -->
<div class="card" style="margin-bottom:20px">
  <h2><span class="icon">üéØ</span> Power Zone Distribution (from Strava Power Data)</h2>
  <div style="display:flex;gap:24px;align-items:center;flex-wrap:wrap">
    <div style="width:240px;height:240px;flex-shrink:0"><canvas id="zoneDonut"></canvas></div>
    <div style="flex:1;min-width:200px">
      <div class="mini-stats" style="grid-template-columns:repeat(4,1fr)">
        <div class="mini-stat"><div class="val" style="color:#94a3b8">__ZONE_RECOVERY_H__</div><div class="lbl">Recovery<br><small>&lt;144W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__ZONE_ENDURANCE_H__</div><div class="lbl">Endurance<br><small>145-196W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">__ZONE_TEMPO_H__</div><div class="lbl">Tempo<br><small>197-236W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:var(--yellow)">__ZONE_THRESHOLD_H__</div><div class="lbl">Threshold<br><small>237-275W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:var(--orange)">__ZONE_VO2_H__</div><div class="lbl">VO2max<br><small>276-314W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:var(--red-light)">__ZONE_ANAEROBIC_H__</div><div class="lbl">Anaerobic<br><small>315-393W</small></div></div>
        <div class="mini-stat"><div class="val" style="color:#e879f9">__ZONE_NEUROMUSCULAR_H__</div><div class="lbl">Neuromuscular<br><small>394W+</small></div></div>
      </div>
      <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">Based on __TOTAL_WORKOUTS__ activities with real power data from Strava. Zones mapped from __COACH_FIRST__ (FTP 262W).</div>
    </div>
  </div>
</div>

<!-- ROW 2: Recovery Dashboard -->
<div id="recovery" class="card" style="margin-bottom:20px">
  <h2><span class="icon">üíö</span> Recovery Dashboard (30 Days)</h2>
  <div class="finding-box">
    <span class="emoji">üî¨</span>
    <span><strong>Key Finding:</strong> __RECOVERY_FINDING__</span>
  </div>
  <div class="grid-3" style="margin-bottom:0">
    <div>
      <h3>Recovery Score</h3>
      <div class="chart-container" style="height:270px"><canvas id="recoveryChart"></canvas></div>
    </div>
    <div>
      <h3>HRV Trend (7-day avg)</h3>
      <div class="chart-container" style="height:270px"><canvas id="hrvChart"></canvas></div>
    </div>
    <div>
      <h3>Sleep Hours</h3>
      <div class="chart-container" style="height:270px"><canvas id="sleepChart"></canvas></div>
    </div>
  </div>
  <div class="mini-stats" style="margin-top:12px">
    <div class="mini-stat"><div class="val" style="color:var(--yellow)">__REC_7D_AVG__</div><div class="lbl">7-Day Avg Recovery</div></div>
    <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__HRV_7D_AVG__</div><div class="lbl">7-Day Avg HRV</div></div>
    <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__SLEEP_7D_AVG__</div><div class="lbl">7-Day Avg Sleep</div></div>
    <div class="mini-stat"><div class="val" style="color:var(--text-secondary)">__REC_30D_CHANGE__</div><div class="lbl">Recovery 30d Change</div></div>
  </div>
</div>

<!-- ROW 3: Workout Quality + FTP -->
<div id="training" class="grid">
  <div class="card">
    <h2><span class="icon">üèãÔ∏è</span> Workout Quality Analysis</h2>
    <h3>Quality by Recovery Bracket</h3>
    <div class="recovery-bracket">
      <div class="bracket red-b">
        <div class="bracket-label">Red (&lt;33%)</div>
        <div class="bracket-value" style="color:var(--red-light)">__QUAL_RED__</div>
        <div class="bracket-n">n=__QUAL_RED_N__</div>
      </div>
      <div class="bracket yellow-b">
        <div class="bracket-label">Yellow (33-66%)</div>
        <div class="bracket-value" style="color:var(--yellow)">__QUAL_YELLOW__</div>
        <div class="bracket-n">n=__QUAL_YELLOW_N__</div>
      </div>
      <div class="bracket green-b">
        <div class="bracket-label">Green (&gt;66%)</div>
        <div class="bracket-value" style="color:var(--green-light)">__QUAL_GREEN__</div>
        <div class="bracket-n">n=__QUAL_GREEN_N__</div>
      </div>
    </div>
    <div class="finding-box" style="background:rgba(59,130,246,0.06);border-color:rgba(59,130,246,0.15)">
      <span class="emoji">üí™</span>
      <span>__QUAL_FINDING__</span>
    </div>
    <h3>Quality Over Time</h3>
    <div class="chart-container" style="height:180px"><canvas id="qualityChart"></canvas></div>
    <h3 style="margin-top:12px">Best Workout Conditions (Top 20)</h3>
    <div class="mini-stats">
      <div class="mini-stat"><div class="val" style="color:var(--green-light)">__BEST_RECOVERY__</div><div class="lbl">Recovery</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__BEST_HRV__</div><div class="lbl">HRV</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__BEST_SLEEP__</div><div class="lbl">Sleep</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__BEST_QUALITY__</div><div class="lbl">Avg Quality</div></div>
    </div>
  </div>

  <div class="card">
    <h2><span class="icon">‚ö°</span> FTP Trajectory</h2>
    <div class="ftp-timeline">
      <div class="ftp-marker"><div class="dot"></div><div class="ftp-val">__FTP__W</div><div class="ftp-date">Now (__TODAY_SHORT__)</div></div>
      <div class="ftp-marker"><div class="dot"></div><div class="ftp-val">__FTP_NEXT_TEST__</div><div class="ftp-date">Next Test (__NEXT_TEST_DATE__)</div></div>
      <div class="ftp-marker"><div class="dot"></div><div class="ftp-val">__FTP_AT_RACE__</div><div class="ftp-date">Vatternrundan (Jun 13)</div></div>
      <div class="ftp-marker"><div class="dot" style="background:var(--green-light)"></div><div class="ftp-val" style="color:var(--green-light)">300W</div><div class="ftp-date">Target (Dec 31)</div></div>
    </div>
    <div class="mini-stats" style="margin-top:20px">
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__FTP__W</div><div class="lbl">Current FTP (est.)</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--yellow)">__RECENT_MAX_NP__W</div><div class="lbl">Recent Max NP</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--orange)">__PEAK_NP__W</div><div class="lbl">Peak NP (__PEAK_NP_DATE__)</div></div>
      <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__NP_TREND__</div><div class="lbl">NP Trend (3mo)</div></div>
    </div>

    <div class="insight-card" style="margin:16px 0;border-color:var(--yellow);background:rgba(234,179,8,0.06)">
      <div class="type" style="color:var(--yellow)">Base Phase Reality Check</div>
      __FTP_INSIGHT_TEXT__
    </div>

    <h3>Monthly Max NP Trend (High-IF Workouts)</h3>
    <div class="chart-container" style="height:160px"><canvas id="npTrendChart"></canvas></div>

    <h3 style="margin-top:16px">FTP Projection (Data-Driven)</h3>
    <div class="chart-container" style="height:200px"><canvas id="ftpChart"></canvas></div>
    <div style="font-size:12px;color:var(--text-muted);margin-top:8px">
      Projection based on actual NP trends, not linear extrapolation. Base phase plateau through March, build phase gains Apr-May, peak at race time. 300W target requires strong summer/fall block.
    </div>
  </div>
</div>

<!-- Key Insights (bridge between training metrics and race planning) -->
<div class="card" style="margin-bottom:20px">
  <h2><span class="icon">üí°</span> Key Insights</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="insight-card">
      <div class="type">üü¢ Recovery Correlation (High Confidence)</div>
      __INSIGHT_RECOVERY__
    </div>
    <div class="insight-card" style="border-color:var(--blue-light);background:rgba(59,130,246,0.06)">
      <div class="type" style="color:var(--blue-light)">üü° HRV Threshold (Medium)</div>
      __INSIGHT_HRV__
    </div>
    <div class="insight-card" style="border-color:var(--yellow);background:rgba(234,179,8,0.06)">
      <div class="type" style="color:var(--yellow)">üî¥ Sleep Impact (Low Confidence)</div>
      __INSIGHT_SLEEP__
    </div>
    <div class="insight-card" style="border-color:var(--green);background:rgba(34,197,94,0.06)">
      <div class="type" style="color:var(--green)">üü¢ Consistency (High Confidence)</div>
      __INSIGHT_CONSISTENCY__
    </div>
    <div class="insight-card" style="border-color:var(--blue-light);background:rgba(59,130,246,0.06);grid-column:1/-1">
      <div class="type" style="color:var(--blue-light)">üü° FTP Outlook (Medium Confidence)</div>
      __INSIGHT_FTP__
    </div>
  </div>
</div>

<!-- ROW 4: Race Plan -->
<div id="race-plans" class="card" style="margin-bottom:20px">
  <h2 class="collapsible-header" onclick="toggleSection(this)"><span><span class="icon">üèÅ</span> V&auml;tternrundan: 315km, June 13, Sub-10h target</span><span class="toggle-icon">‚ñ∏</span></h2>
  <div class="collapsible-content">
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
    <span class="badge badge-blue">315 km / 196 mi</span>
    <span class="badge badge-green">Target: Sub-10 Hours (finish by 1:20 PM)</span>
    <span class="badge badge-yellow">Start: 03:20 AM &middot; 4 Stops</span>
    <span class="badge badge-blue">Riding with friend (drafting)</span>
    <span class="phase-indicator phase-base">__PHASE_INDICATOR__</span>
  </div>

  <div class="grid" style="margin-bottom:0">
    <div>
      <h3>Course Segments &amp; Power Targets</h3>
      <div class="table-scroll"><table class="segment-table">
        <thead><tr><th>Segment</th><th>Distance</th><th>Power @ __PROJ_RACE_FTP__W FTP</th></tr></thead>
        <tbody>
          __RACE_SEGMENTS_ROWS__
        </tbody>
      </table></div>
      <div class="mini-stats" style="margin-top:12px">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__RACE_TARGET_NP__W</div><div class="lbl">Target NP</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--red-light)">__RACE_CLIMB_CAP__W</div><div class="lbl">Climb Cap (__RACE_CLIMB_CAP_PCT__%)</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">~__RACE_EST_TSS__</div><div class="lbl">Est. TSS</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">IF __RACE_TARGET_IF__</div><div class="lbl">Target IF</div></div>
      </div>

      <h3 style="margin-top:16px">2025 Race Comparison</h3>
      <div class="table-scroll"><table class="segment-table">
        <thead><tr><th>Metric</th><th>2025 (Solo)</th><th>2026 Target</th></tr></thead>
        <tbody>
          <tr><td>Time</td><td>10h09m</td><td>&lt;10h00m</td></tr>
          <tr><td>NP</td><td>215W</td><td>__RACE_TARGET_NP__W</td></tr>
          <tr><td>IF</td><td>0.82</td><td>__RACE_TARGET_IF__</td></tr>
          <tr><td>TSS</td><td>682</td><td>~__RACE_EST_TSS__</td></tr>
          <tr><td>Avg HR</td><td>142</td><td>TBD</td></tr>
          <tr><td>Start</td><td>Morning</td><td>03:20 AM</td></tr>
          <tr><td>Style</td><td>Solo, pushed hard</td><td>With friend (drafting + morale)</td></tr>
        </tbody>
      </table></div>
      <div class="insight-card" style="margin-top:12px;border-color:var(--green);background:rgba(34,197,94,0.06)">
        <div class="type" style="color:var(--green)">2025 vs 2026 Analysis</div>
        2025 was ridden solo at IF 0.82 / NP 215W &mdash; quite aggressive for a 10-hour effort. The fact __ATHLETE_FIRST__ finished strong (feeling: 1/great) shows deep endurance capacity. 2026 target of IF __RACE_TARGET_IF__ at __PROJ_RACE_FTP__W FTP (NP __RACE_TARGET_NP__W) is a smart strategy. Lower relative effort than 2025 but higher absolute power due to FTP gains. With a friend for drafting (__RACE_DRAFT_PCT__% aero savings) and disciplined pacing, sub-10 is very achievable.
      </div>
    </div>

    <div>
      <h3>Depot Stops (4 Stops, ~54 min total)</h3>
      <div class="stop-timeline">
        <div class="stop-item">
          <div class="stop-name">&Ouml;lmstad &mdash; 83 km / 52 mi &middot; ~5:58 AM</div>
          <div class="stop-detail">10 min stop. Refill F369 bottles, pickles + bread.</div>
        </div>
        <div class="stop-item hot">
          <div class="stop-name">üçΩÔ∏è J&ouml;nk&ouml;ping &mdash; 104 km / 65 mi &middot; ~6:48 AM</div>
          <div class="stop-detail">22 min stop. HOT FOOD: meatballs, mashed potatoes, blueberry soup. Refill bottles.</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">Karlsborg &mdash; 204 km / 127 mi &middot; ~10:20 AM</div>
          <div class="stop-detail">12 min stop. Refill F369, pickles + bread, stretch.</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">Godeg&aring;rd &mdash; 284 km / 176 mi &middot; ~1:04 PM</div>
          <div class="stop-detail">10 min stop. Last refill, push to finish.</div>
        </div>
      </div>
      <div style="padding:8px 14px;background:rgba(234,179,8,0.08);border-radius:8px;margin-top:8px;font-size:12px;color:var(--text-secondary)">
        <strong style="color:var(--yellow)">Note:</strong> Thousands of participants means depot stops take time. These are realistic estimates.
      </div>
      <div style="padding:10px 14px;background:rgba(217,119,6,0.08);border-radius:8px;margin-top:12px;font-size:12px;color:var(--text-secondary)">
        <strong style="color:var(--orange)">Primary Fuel: Formula 369</strong> &mdash; 30g carbs/scoop, 1:1 glucose:fructose, 200mg sodium. 3 bottles (2 cage + 1 flexible rubber). Mix 2-3 scoops/bottle (60-90g carbs). Target: <strong style="color:var(--text-primary)">80-90g carbs/hour</strong>. Supplemental gels between bottles as needed. Pre-dawn start: 03:20 AM, sunrise 03:51 AM. Only ~30 min of darkness. No night riding..
      </div>

      <h3 style="margin-top:16px">Hourly Fueling Timeline</h3>
      <div class="table-scroll"><table class="segment-table">
        <thead><tr><th>Hour</th><th>Clock Time</th><th>Fueling Plan</th><th>Carbs</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>03:20-04:20</td><td>1 bottle F369 + start eating early</td><td>60-90g</td></tr>
          <tr><td>2-3</td><td>04:20-06:20</td><td>Continue bottles, gel every 45 min. <strong>Stop 1 at 5:52 AM</strong></td><td>160-180g</td></tr>
          <tr><td>4-5</td><td>06:20-08:20</td><td>Steady bottles + gels</td><td>160-180g</td></tr>
          <tr><td>5-6</td><td>08:20-09:20</td><td><strong>J&ouml;nk&ouml;ping 8:43 AM:</strong> hot meal, blueberry soup, refill</td><td>80-90g</td></tr>
          <tr><td>7-8</td><td>09:20-11:20</td><td>Bottles + gels. <strong>Stop 3 at 10:57 AM</strong>, refill</td><td>160-180g</td></tr>
          <tr><td>9-10</td><td>11:20-13:20</td><td><strong>Stop 4 at 12:32 PM</strong>, last refill, final push</td><td>160-180g</td></tr>
          <tr style="background:rgba(34,197,94,0.08)"><td colspan="3"><strong>Total Target (10 hours)</strong></td><td><strong>800-900g (7,000+ cal)</strong></td></tr>
        </tbody>
      </table></div>

      <h3 style="margin-top:16px">Taper Timeline</h3>
      <div class="table-scroll"><table class="segment-table">
        <thead><tr><th>Date</th><th>Phase</th><th>Days Out</th></tr></thead>
        <tbody>
          <tr><td>May 1</td><td>Build phase starts</td><td>78</td></tr>
          <tr><td>May 22</td><td>Peak week</td><td>99</td></tr>
          <tr><td>Jun 6</td><td><span class="badge badge-yellow">üèÅ Halvvattern 150km (peak effort / dress rehearsal)</span></td><td>7</td></tr>
          <tr><td>Jun 7-9</td><td>Easy spins (taper begins)</td><td>4-6</td></tr>
          <tr><td>Jun 10</td><td>Opener session</td><td>3</td></tr>
          <tr><td>Jun 11-12</td><td>Easy spin + prep</td><td>1-2</td></tr>
          <tr><td>Jun 13</td><td><span class="badge badge-green">üèÅ VATTERNRUNDAN (03:20 AM)</span></td><td>0</td></tr>
        </tbody>
      </table></div>
      <div class="mini-stats" style="margin-top:12px">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">__PROJ_RACE_CTL__</div><div class="lbl">Proj. Race CTL</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">__PROJ_RACE_TSB__</div><div class="lbl">Proj. Race TSB</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--orange)">~54 min</div><div class="lbl">Total Stop Time</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">~10h total</div><div class="lbl">9.1h ride + stops</div></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ROW 4b: Halvv√§ttern -->
<div class="card" style="margin-bottom:20px">
  <h2 class="collapsible-header" onclick="toggleSection(this)"><span><span class="icon">üî•</span> Halvv&auml;ttern: 150km, June 6, Dress Rehearsal</span><span class="toggle-icon">‚ñ∏</span></h2>
  <div class="collapsible-content">
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
    <span class="badge badge-blue">150 km / 93 mi</span>
    <span class="badge badge-yellow">June 6, 2026 &middot; 7 days before V&auml;tternrundan</span>
    <span class="badge badge-green">Dress Rehearsal / Peak Effort</span>
    <span class="badge badge-blue">6 Service Stops</span>
  </div>

  <div class="grid" style="margin-bottom:0">
    <div>
      <h3>Route Overview</h3>
      <p style="font-size:13px;color:var(--text-secondary);line-height:1.7;margin-bottom:12px">
        150km loop starting and finishing in Motala. South along V&auml;ttern shore past Vadstena, climbs Omberg nature reserve, south to &Ouml;desh&ouml;g, east through forests, north through farmland via R&ouml;k and medieval churches to Sk&auml;nninge, back to Motala.
      </p>

      <h3>Service Stops</h3>
      <div class="stop-timeline">
        <div class="stop-item">
          <div class="stop-name">Borghamn &mdash; 32 km</div>
          <div class="stop-detail">Full service stop</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">Stocklycke &mdash; 42 km</div>
          <div class="stop-detail">Water only</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">&Ouml;desh&ouml;g &mdash; 53 km</div>
          <div class="stop-detail">Full service stop</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">Boet &mdash; 80 km</div>
          <div class="stop-detail">Water only</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">R&ouml;k &mdash; 103 km</div>
          <div class="stop-detail">Full service stop</div>
        </div>
        <div class="stop-item">
          <div class="stop-name">Sk&auml;nninge &mdash; 127 km</div>
          <div class="stop-detail">Full service stop</div>
        </div>
      </div>
    </div>

    <div>
      <h3>2025 Halvv&auml;ttern Performance (June 7, 2025)</h3>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">4h49m</div><div class="lbl">Time</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">92.3 mi</div><div class="lbl">Distance</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--orange)">372</div><div class="lbl">TSS</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--red-light)">0.88</div><div class="lbl">IF</div></div>
      </div>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">230W</div><div class="lbl">NP</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--text-secondary)">211W</div><div class="lbl">Avg Power</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--red-light)">145/167</div><div class="lbl">Avg/Max HR</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">86</div><div class="lbl">Cadence</div></div>
      </div>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">2,628 ft</div><div class="lbl">Elevation</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--yellow)">3,670</div><div class="lbl">Calories</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">7 / 1</div><div class="lbl">RPE / Feeling</div></div>
      </div>
      <div class="insight-card" style="margin-top:12px;border-color:var(--orange);background:rgba(217,119,6,0.06)">
        <div class="type" style="color:var(--orange)">__ATHLETE_FIRST__'s 2025 Race Note</div>
        "20 mph headwinds gusting to 45 mph on the large open fields was rough. Thankfully that headwind turned into a tailwind at the southern end."
      </div>

      <h3 style="margin-top:16px">2026 Targets (@ ~__PROJ_RACE_FTP__W FTP)</h3>
      <div class="mini-stats">
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">230-240W</div><div class="lbl">Target NP</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--blue-light)">IF 0.83-0.87</div><div class="lbl">Target IF</div></div>
        <div class="mini-stat"><div class="val" style="color:var(--green-light)">&lt;4h49m</div><div class="lbl">Time Goal</div></div>
      </div>
      <div class="insight-card" style="margin-top:12px;border-color:var(--green);background:rgba(34,197,94,0.06)">
        <div class="type" style="color:var(--green)">Race Strategy</div>
        This is the final hard effort before V&auml;tternrundan. Race it hard as a dress rehearsal &mdash; validate fitness, test fueling, and confirm pacing. The 1-week gap to V&auml;tternrundan is perfect: Halvv&auml;ttern doubles as both peak effort and start of taper. __ATHLETE_FIRST__ did exactly this in 2025 with great results.
      </div>
    </div>
  </div>
</div>

</div>

<!-- ROW 5: Coach Analysis -->
<div id="coach" class="card" style="margin-bottom:20px">
  <h2><span class="icon">üéØ</span> Coaching Assessment</h2>
  <div class="coach-text">
    __COACHING_TEXT__


<!-- ROW 6: Insights + Weekly Summary (moved to top, kept here as anchor) -->
  </div>
</div>
<!-- This Week and Insights already moved to position #2 above -->

<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">
  Generated __GENERATED_DATE__ &middot; Data from TrainingPeaks + Whoop &middot; Coaching by __COACH_NAME__
  <br><div class="data-freshness"><span class="pulse"></span> Last synced: __GENERATED_DATE__</div>
</div>

</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const weeklyTSS = __WEEKLY_TSS_DATA__;

const pmcData = __PMC_DATA__;

const recovery30 = __RECOVERY_30_DATA__;

const hrv30 = __HRV_30_DATA__;

const sleep30 = __SLEEP_30_DATA__;

const qualityData = __QUALITY_DATA__;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Chart.defaults.color = '#9ca3b4';
Chart.defaults.borderColor = 'rgba(42,45,58,0.5)';
Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
Chart.defaults.font.size = 11;

// Collapsible section toggle
function toggleSection(header) {
  header.classList.toggle('open');
  const content = header.nextElementSibling;
  while(content && !content.classList.contains('collapsible-content')) { break; }
  // Find the collapsible-content sibling
  let el = header.nextElementSibling;
  while(el) {
    if(el.classList && el.classList.contains('collapsible-content')) {
      el.classList.toggle('open');
      break;
    }
    el = el.nextElementSibling;
  }
}

// TSS Chart - default to last 20 weeks
let showFullTSS = false;
let tssChart;
function getTSSSlice() {
  if(showFullTSS) return weeklyTSS;
  return weeklyTSS.slice(-20);
}
function renderTSSChart() {
  const slice = getTSSSlice();
  if(tssChart) tssChart.destroy();
  tssChart = new Chart(document.getElementById('tssChart'), {
    type: 'bar',
    data: {
      labels: slice.map(d=>d.week),
      datasets: [{
        data: slice.map(d=>d.tss),
        backgroundColor: slice.map(d=> {
          if(d.flu) return 'rgba(239,68,68,0.7)';
          if(d.tss>=500) return 'rgba(59,130,246,0.8)';
          if(d.tss>=300) return 'rgba(59,130,246,0.5)';
          return 'rgba(59,130,246,0.25)';
        }),
        borderRadius: 3,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {display:false},
        tooltip: {
          callbacks: {
            label: ctx => {
              const idx = showFullTSS ? ctx.dataIndex : ctx.dataIndex + (weeklyTSS.length - 20);
              let extra = weeklyTSS[idx] && weeklyTSS[idx].flu ? ' (FLU WEEK)' : '';
              return `TSS: ${ctx.raw}${extra}`;
            }
          }
        }
      },
      scales: {
        x: {ticks:{maxRotation:45,font:{size:9}},grid:{display:false}},
        y: {beginAtZero:true,title:{display:true,text:'Weekly TSS'}}
      }
    }
  });
}
function toggleTSSRange() {
  showFullTSS = !showFullTSS;
  document.getElementById('tssToggle').textContent = showFullTSS ? 'Show last 20 weeks' : 'Show full year';
  document.getElementById('tssRangeLabel').textContent = showFullTSS ? '(12 Months)' : '(Last 20 Weeks)';
  renderTSSChart();
}
renderTSSChart();

// PMC Chart
new Chart(document.getElementById('pmcChart'), {
  type: 'line',
  data: {
    labels: pmcData.map(d=>d.d),
    datasets: [
      {label:'CTL (Fitness)',data:pmcData.map(d=>d.ctl),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.3,pointRadius:2},
      {label:'ATL (Fatigue)',data:pmcData.map(d=>d.atl),borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.05)',fill:false,tension:0.3,pointRadius:2},
      {label:'TSB (Form)',data:pmcData.map(d=>d.tsb),borderColor:'#22c55e',backgroundColor:'rgba(34,197,94,0.05)',fill:true,tension:0.3,pointRadius:2,borderDash:[4,4]}
    ]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: {legend:{position:'top',labels:{boxWidth:12,padding:8}}},
    scales: {
      x: {ticks:{maxRotation:45,font:{size:9}},grid:{display:false}},
      y: {title:{display:true,text:'Load / Form'}}
    }
  }
});

// Recovery Chart
new Chart(document.getElementById('recoveryChart'), {
  type: 'bar',
  data: {
    labels: recovery30.map(d=>d.d),
    datasets: [{
      data: recovery30.map(d=>d.r),
      backgroundColor: recovery30.map(d=> d.r>=67?'rgba(34,197,94,0.6)':d.r>=34?'rgba(234,179,8,0.6)':'rgba(239,68,68,0.6)'),
      borderRadius: 2,
    }]
  },
  options: {
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{x:{ticks:{maxRotation:45,font:{size:8},maxTicksLimit:10},grid:{display:false}},y:{beginAtZero:true,max:100}}
  }
});

// HRV Chart
const hrv7d = hrv30.map((d,i)=>{
  const slice = hrv30.slice(Math.max(0,i-6),i+1);
  return slice.reduce((a,b)=>a+b.h,0)/slice.length;
});
new Chart(document.getElementById('hrvChart'), {
  type:'line',
  data:{
    labels:hrv30.map(d=>d.d),
    datasets:[
      {label:'HRV',data:hrv30.map(d=>d.h),borderColor:'rgba(96,165,250,0.3)',pointRadius:2,pointBackgroundColor:'rgba(96,165,250,0.5)',fill:false,tension:0.1},
      {label:'7d Avg',data:hrv7d,borderColor:'#60a5fa',borderWidth:2,pointRadius:0,fill:false,tension:0.3}
    ]
  },
  options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{x:{ticks:{maxRotation:45,font:{size:8},maxTicksLimit:10},grid:{display:false}},y:{title:{display:true,text:'ms'}}}
  }
});

// Sleep Chart
new Chart(document.getElementById('sleepChart'), {
  type:'bar',
  data:{
    labels:sleep30.map(d=>d.d),
    datasets:[{
      data:sleep30.map(d=>d.s),
      backgroundColor:sleep30.map(d=>d.s>=7.5?'rgba(96,165,250,0.6)':d.s>=6?'rgba(96,165,250,0.35)':'rgba(239,68,68,0.4)'),
      borderRadius:2,
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},annotation:{}},
    scales:{x:{ticks:{maxRotation:45,font:{size:8},maxTicksLimit:10},grid:{display:false}},y:{min:4,max:10,title:{display:true,text:'Hours'}}}
  }
});

// Quality Chart
new Chart(document.getElementById('qualityChart'), {
  type:'line',
  data:{
    labels:qualityData.map(d=>d.d),
    datasets:[{
      data:qualityData.map(d=>d.q),
      borderColor:'#60a5fa',
      backgroundColor:'rgba(96,165,250,0.1)',
      fill:true,tension:0.3,pointRadius:2,pointBackgroundColor:'#60a5fa'
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{x:{ticks:{maxRotation:45,font:{size:8},maxTicksLimit:12},grid:{display:false}},y:{min:60,max:100,title:{display:true,text:'Quality Score'}}}
  }
});

// Zone Distribution Donut
new Chart(document.getElementById('zoneDonut'), {
  type:'doughnut',
  data:{
    labels:['Recovery','Endurance','Tempo','Threshold','VO2max','Anaerobic','Neuromuscular'],
    datasets:[{
      data:__ZONE_DONUT_DATA__,
      backgroundColor:['#94a3b8','#60a5fa','#4ade80','#eab308','#f97316','#f87171','#e879f9'],
      borderColor:'#1a1d27',borderWidth:2,
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:true,
    cutout:'60%',
    plugins:{
      legend:{display:false},
      tooltip:{callbacks:{label:ctx=>{const total=ctx.dataset.data.reduce((a,b)=>a+b,0);const pct=total?((ctx.raw/total)*100).toFixed(1):0;return `${ctx.label}: ${(ctx.raw/60).toFixed(1)}h (${pct}%)`;}}}
    }
  }
});

// Mobile: reduce chart tick density
if(window.innerWidth <= 600) {
  Chart.defaults.scales.x = Chart.defaults.scales.x || {};
  Chart.defaults.plugins.legend.labels.font = {size: 9};
}
const isMobile = window.innerWidth <= 600;
const mobileMaxTicks = isMobile ? 6 : undefined;

// Monthly Max NP Trend Chart
new Chart(document.getElementById('npTrendChart'), {
  type:'bar',
  data:{
    labels:__NP_TREND_LABELS__,
    datasets:[{
      label:'Max NP',
      data:__NP_TREND_DATA__,
      backgroundColor:__NP_TREND_COLORS__,
      borderRadius:3,
    }]
  },
  options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`Max NP: ${ctx.raw}W`}}},
    scales:{x:{grid:{display:false},ticks:{font:{size:9}}},y:{min:200,max:260,title:{display:true,text:'Watts'}}}
  }
});

// FTP Projection Chart (data-driven)
const ftpMonths = ['Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
// Base plateau Feb-Mar, build phase gains Apr-Jun, continued gains Jul-Dec
const ftpProjection = __FTP_PROJECTION_DATA__;
new Chart(document.getElementById('ftpChart'), {
  type:'line',
  data:{
    labels:ftpMonths,
    datasets:[
      {label:'Projected FTP',data:ftpProjection,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.3,pointRadius:3},
      {label:'300W Target',data:ftpMonths.map(()=>300),borderColor:'rgba(34,197,94,0.4)',borderDash:[6,4],pointRadius:0,fill:false},
      {label:'Base Phase',data:[263,263,265,null,null,null,null,null,null,null,null],borderColor:'rgba(234,179,8,0.6)',borderWidth:3,pointRadius:0,fill:false,tension:0.3},
      {label:'Build Phase',data:[null,null,265,272,278,null,null,null,null,null,null],borderColor:'rgba(249,115,22,0.8)',borderWidth:3,pointRadius:0,fill:false,tension:0.3}
    ]
  },
  options:{
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'top',labels:{boxWidth:12,padding:8}}},
    scales:{x:{grid:{display:false}},y:{min:255,max:310,title:{display:true,text:'Watts'}}}
  }
});
</script>
</body>
</html>